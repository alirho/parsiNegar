# مستندات فنی پارسی‌نگار

این سند به تشریح معماری، ساختار و جریان داده در پروژه پارسی‌نگار می‌پردازد. هدف آن ارائه یک دید کلی برای توسعه‌دهندگان جدید و درک عمیق‌تر از نحوه عملکرد برنامه است.

## ۱. نمای کلی معماری

پارسی‌نگار بر اساس یک **معماری ماژولار و رویداد-محور (Event-Driven)** ساخته شده است. این رویکرد به جداسازی مسئولیت‌ها (Separation of Concerns) کمک کرده و توسعه و نگهداری کد را آسان‌تر می‌کند.

- **ماژولار (Modular):** هر بخش از برنامه (مانند ویرایشگر، پیش‌نمایش، مدیریت فایل) در یک ماژول جداگانه قرار دارد. این ماژول‌ها تا حد امکان مستقل از یکدیگر عمل می‌کنند.
- **رویداد-محور (Event-Driven):** به جای اینکه ماژول‌ها مستقیماً یکدیگر را فراخوانی کنند، از طریق یک گذرگاه رویداد مرکزی (`EventBus`) با هم ارتباط برقرار می‌کنند. برای مثال، وقتی کاربر متنی را در ویرایشگر تایپ می‌کند، ماژول ویرایشگر یک رویداد `editor:contentChanged` را منتشر می‌کند. سپس ماژول‌های دیگر مانند پیش‌نمایش، نوار وضعیت و ذخیره‌سازی خودکار به این رویداد گوش داده و وظایف خود را انجام می‌دهند.

## ۲. ساختار پوشه‌ها

ساختار پروژه به شکل زیر سازماندهی شده است:

```
.
├── assets/
│   ├── css/          # فایل‌های استایل (CSS) به صورت ماژولار
│   └── pic/          # تصاویر و آیکون‌ها
├── doc/              # مستندات پروژه (فنی و کاربری)
├── js/
│   ├── core/         # ماژول‌های هسته اصلی برنامه
│   ├── features/     # ماژول‌های مربوط به ویژگی‌های برنامه
│   ├── markdown/     # منطق مربوط به پردازش مارک‌داون
│   └── utils/        # توابع و ابزارهای کمکی
├── libs/             # کتابخانه‌های جانبی (مانند پارس‌نشان)
├── index.html        # فایل اصلی HTML
└── ...
```

- **`assets/css`**: استایل‌ها به بخش‌های کوچک‌تر (مانند `_base.css`, `_toolbar.css`) تقسیم شده‌اند تا مدیریت آن‌ها ساده‌تر باشد.
- **`js/core`**: شامل ستون فقرات برنامه است: `app.js` (نقطه شروع)، `editor.js` (منطق ویرایشگر)، `eventBus.js` (سیستم ارتباطی) و `state.js` (وضعیت کلی برنامه).
- **`js/features`**: هر فایل در این پوشه یک ویژگی خاص از برنامه را پیاده‌سازی می‌کند (مانند `search.js`, `settings.js`, `fileManager.js`).
- **`js/markdown`**: این بخش به عنوان یک نما (Facade) عمل می‌کند و منطق مربوط به انتخاب و پیکربندی مفسرهای مختلف مارک‌داون را مدیریت می‌کند.
- **`js/utils`**: شامل توابع کمکی عمومی مانند انتخاب‌گرهای DOM، ذخیره‌سازی در IndexedDB و توابع کمکی دیگر است.

## ۳. ماژول‌های اصلی (Core Modules)

### `app.js`
نقطه ورود اصلی برنامه است. وظیفه آن ایجاد یک نمونه از کلاس `ParsiNegarApp` است که به نوبه خود تمام ماژول‌های دیگر را مقداردهی اولیه کرده و آن‌ها را به هم متصل می‌کند.

### `editor.js`
این کلاس تمام تعاملات با عنصر `<textarea>` را مدیریت می‌کند. مسئولیت‌های آن عبارتند از:
- مدیریت تاریخچه برای واگرد/ازنو (Undo/Redo).
- رسیدگی به رویدادهای ورودی و صفحه‌کلید (مانند Tab، تکمیل خودکار جفت‌ها).
- پیاده‌سازی کلیدهای میانبر برای قالب‌بندی متن.
- انتشار رویداد `editor:contentChanged` هنگام تغییر محتوا.

### `eventBus.js`
یک پیاده‌سازی ساده از الگوی انتشار/اشتراک (Pub/Sub) است. این ماژول به عنوان یک هماهنگ‌کننده مرکزی عمل می‌کند و به ماژول‌ها اجازه می‌دهد بدون وابستگی مستقیم با یکدیگر ارتباط برقرار کنند.

### `state.js`
یک مخزن مرکزی برای نگهداری وضعیت کلی برنامه است که بین ماژول‌های مختلف به اشتراک گذاشته می‌شود. مواردی مانند `currentFileId` (شناسه فایل فعلی) در این ماژول نگهداری می‌شوند.

## ۴. جریان داده (Data Flow)

یک مثال از جریان داده در برنامه، فرآیند تایپ توسط کاربر است:

1.  **کاربر** متنی را در `<textarea>` تایپ می‌کند.
2.  **`editor.js`** رویداد `input` را دریافت کرده و یک رویداد `editor:contentChanged` را از طریق `EventBus` منتشر می‌کند.
3.  **`preview.js`** به این رویداد گوش می‌دهد، محتوای جدید را دریافت کرده و آن را به HTML رندر می‌کند.
4.  **`statusBar.js`** به این رویداد گوش می‌دهد و آمار متن (تعداد کلمات، حروف و...) را به‌روزرسانی می‌کند.
5.  **`autoSave.js`** به این رویداد گوش می‌دهد و پس از یک تأخیر کوتاه (debounce)، محتوا را در IndexedDB و localStorage ذخیره می‌کند.
6.  **`sidePanel.js`** (به‌طور خاص بخش TOC) به این رویداد گوش می‌دهد و فهرست مطالب را به‌روزرسانی می‌کند.

این جریان یک‌طرفه و مبتنی بر رویداد، کد را قابل پیش‌بینی و اشکال‌زدایی آن را آسان‌تر می‌کند.

## ۵. پردازش مارک‌داون

منطق پردازش در پوشه `js/markdown` قرار دارد:

- **`parser.js`**: به عنوان یک **نما (Facade)** عمل می‌کند. این ماژول بر اساس انتخاب کاربر در تنظیمات، یکی از مفسرهای (Marked.js, Parsneshan) را برای تبدیل مارک‌داون به HTML انتخاب و استفاده می‌کند. این کار باعث می‌شود بقیه برنامه نیازی به دانستن جزئیات مفسر فعلی نداشته باشد.
- **`highlighter.js`**: مسئولیت مدیریت هایلایت کردن سینتکس کد (با استفاده از `highlight.js`) و رندر نمودارها (با استفاده از `mermaid.js`) را بر عهده دارد.

## ۶. کتابخانه‌های جانبی

پارسی‌نگار از چندین کتابخانه قدرتمند استفاده می‌کند:

- **Marked.js / markdown-it**: برای پردازش مارک‌داون استاندارد.
- **Parsneshan**: یک کتابخانه سفارشی مبتنی بر `markdown-it` برای پشتیبانی از سینتکس‌های خاص زبان فارسی.
- **highlight.js**: برای هایلایت کردن سینتکس بلوک‌های کد.
- **Mermaid.js**: برای رندر کردن نمودارها و دیاگرام‌ها.
- **html2pdf.js**: برای خروجی گرفتن به فرمت PDF.
- **JSZip**: برای ایجاد خروجی فشرده (zip) از تمام فایل‌ها.
- **FontAwesome**: برای نمایش آیکون‌ها.
